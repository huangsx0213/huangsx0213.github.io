---
layout:     post
title:      "Selenium E2E 测试框架架构方案"
subtitle:   "「 End to End Auto Testing 」" 
date:       2025-11-24 11:00:00
author:     "Vick Huang"
header-img: "img/bg-walle.jpg"
catalog: true
tags:
    - Testing
    - Automated Testing
---


# Oracle Database Connection Tests Analysis

This document contains the source code and analysis for two Python scripts designed to test connectivity and basic operations with an Oracle Database.

## 1. `test_oracle.py`

This script demonstrates how to interact with an Oracle Database using the `oracledb` driver directly (DB-API 2.0 interface). It performs a full cycle of operations: connecting, creating a table, inserting data, querying, and cleaning up.

### Source Code

```python
import oracledb
import sys

# Connection details
user = "system"
password = "Oracle123"
dsn = "localhost:1521/XE"

try:
    # Connect to the database
    connection = oracledb.connect(user=user, password=password, dsn=dsn)
    print("Successfully connected to Oracle Database")
    
    # Get the version
    print("Database version:", connection.version)
    print("Is Thin mode:", connection.thin)

    cursor = connection.cursor()

    # Create a table
    try:
        cursor.execute("DROP TABLE test_user")
    except oracledb.Error:
        pass # Table might not exist

    cursor.execute("""
        CREATE TABLE test_user (
            id NUMBER GENERATED BY DEFAULT AS IDENTITY,
            name VARCHAR2(50),
            email VARCHAR2(50)
        )
    """)
    print("Table 'test_user' created.")

    # Insert data
    users = [("Alice", "alice@example.com"), ("Bob", "bob@example.com")]
    cursor.executemany("INSERT INTO test_user (name, email) VALUES (:1, :2)", users)
    connection.commit()
    print(f"Inserted {cursor.rowcount} rows.")

    # Query data
    cursor.execute("SELECT * FROM test_user")
    rows = cursor.fetchall()
    print("Data in 'test_user':")
    for row in rows:
        print(row)

    cursor.close()
    connection.close()
except oracledb.Error as e:
    print(f"Error connecting to Oracle Database: {e}")
    sys.exit(1)
```

### Analysis & Explanation

1.  **Driver & Connection**:
    *   Uses the `oracledb` library, which is the modern, thin-client capable driver for Oracle (replacing `cx_Oracle`).
    *   Connects using `oracledb.connect()` with standard credentials (`user`, `password`, `dsn`).
    *   Checks `connection.thin` to confirm if it's running in "Thin" mode (no Oracle Client libraries required) or "Thick" mode.

2.  **DDL Operations (Data Definition Language)**:
    *   It attempts to `DROP` the table `test_user` first to ensure a clean state. The `try-except` block gracefully handles the case where the table doesn't exist yet.
    *   Creates a new table `test_user` with an `IDENTITY` column for auto-incrementing IDs.

3.  **DML Operations (Data Manipulation Language)**:
    *   **Batch Insertion**: Uses `cursor.executemany()` for efficient bulk insertion of data.
    *   **Binding**: Uses positional bind variables (`:1`, `:2`) which is a security best practice to prevent SQL injection.
    *   **Commit**: Explicitly calls `connection.commit()` to save changes.

4.  **Querying**:
    *   Executes a standard `SELECT` statement and retrieves all rows using `cursor.fetchall()`.

---

## 2. `test_sqlalchemy.py`

This script demonstrates how to interact with the Oracle Database using **SQLAlchemy**, a popular Python SQL Toolkit and Object Relational Mapper (ORM). This approach abstracts away raw SQL queries and deals with Python objects.

### Source Code

```python
from sqlalchemy import create_engine, Column, Integer, String, Sequence
from sqlalchemy.orm import declarative_base
from sqlalchemy.orm import sessionmaker

# --- Configuration ---
# Connection string format for python-oracledb in Thin mode:
# oracle+oracledb://<username>:<password>@<dsn>
USER = "system"
PASSWORD = "Oracle123"
DSN = "localhost:1521/XE"
CONNECTION_STRING = f"oracle+oracledb://{USER}:{PASSWORD}@{DSN}"

# --- Setup ---
# Explicitly enable Thin mode (this is the default, but good for clarity)
# To use Thick mode, you would call oracledb.init_oracle_client() here.
import oracledb
# oracledb.init_oracle_client() # Uncomment this for Thick mode

engine = create_engine(CONNECTION_STRING)
Base = declarative_base()

# Verify Connection Mode
try:
    with engine.connect() as connection:
        # Access the underlying DBAPI connection
        dbapi_conn = connection.connection.dbapi_connection
        print(f"Database version: {dbapi_conn.version}")
        print(f"Is Thin mode: {dbapi_conn.thin}")
except Exception as e:
    print(f"Error verifying connection mode: {e}")

# --- Model Definition ---
class User(Base):
    __tablename__ = 'sqlalchemy_users'
    
    id = Column(Integer, Sequence('user_id_seq'), primary_key=True)
    name = Column(String(50))
    email = Column(String(50))

    def __repr__(self):
        return f"<User(id={self.id}, name='{self.name}', email='{self.email}')>"

    def __str__(self):
        return f"{self.id} {self.name} {self.email}"

# --- Main Execution ---
if __name__ == "__main__":
    # 1. Reset the table (Drop if exists, then Create)
    try:
        User.__table__.drop(engine, checkfirst=True)
        Base.metadata.create_all(engine)
        print("Table 'sqlalchemy_users' reset successfully.")
    except Exception as e:
        print(f"Error resetting table: {e}")

    # 2. Create a session
    Session = sessionmaker(bind=engine)
    session = Session()

    try:
        # 3. Insert data
        users = [
            User(name="Alice", email="alice@example.com"),
            User(name="Bob", email="bob@example.com")
        ]
        session.add_all(users)
        session.commit()
        print(f"Inserted {len(users)} users.")

        # 4. Query and display data
        print("\nAll users in 'sqlalchemy_users':")
        all_users = session.query(User).all()
        for user in all_users:
            print(user) # Uses __str__ method

    except Exception as e:
        print(f"An error occurred: {e}")
        session.rollback()
    finally:
        session.close()
```

### Analysis & Explanation

1.  **SQLAlchemy Configuration**:
    *   Uses the `oracle+oracledb` dialect in the connection string. This tells SQLAlchemy to use the `oracledb` driver.
    *   Creates an `engine` which manages the connection pool.

2.  **ORM Model (`User` class)**:
    *   Defines a class `User` that inherits from `Base`. This maps the Python class to the `sqlalchemy_users` database table.
    *   Defines columns (`id`, `name`, `email`) with specific types.
    *   Uses `Sequence('user_id_seq')` for the primary key, which is the traditional Oracle way to handle auto-increments (though modern Oracle versions support IDENTITY columns, SQLAlchemy often defaults to sequences for broad compatibility).

3.  **Schema Management**:
    *   `User.__table__.drop(engine, checkfirst=True)`: Safely drops the table if it exists.
    *   `Base.metadata.create_all(engine)`: Automatically generates the `CREATE TABLE` SQL based on the model definition and executes it.

4.  **Session & Transaction Management**:
    *   Uses `sessionmaker` to create a `Session` factory.
    *   The session is used to manage transactions (add, commit, rollback).
    *   `session.add_all(users)`: Adds Python objects to the session.
    *   `session.commit()`: Persists changes to the database.

5.  **Querying**:
    *   `session.query(User).all()`: Retrieves all records as a list of `User` objects, allowing you to work with them using standard Python attributes (e.g., `user.name`) rather than raw tuples.
